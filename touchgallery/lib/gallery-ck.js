(function(e){function t(t){this.container=e(t.container);this.items=t.items;this.readyHandler=t.readyHandler?t.readyHandler:function(){};t.template&&(this.template=t.template);this.position=null;this.initialPosition=null;this.targetPosition=null;this.currentItem=null;this.list=null;this.lastTickTime=null;this.easeFactor=.15;this.interacting=!1;this.touchCoords=null;this.touchId=null;this.tapCandidate=null;this.videoCounter=0;this._scrolling=!0;this.swipeLength=.15;this.constructor.boundHandlers.forEach(function(e){this[e]=bind(this,this[e])},this);var n=this;window.addEventListener("orientationchange",function(){viewporter.refresh()});window.addEventListener("viewportchange",this.handleResize);this.preloadImages(this.init)}function n(t){e.extend(this,EventEmitter);var n=this;this.ready=!1;this.iframe=t;this.handleMessage=bind(this,this.handleMessage);this.handleReady=bind(this,this.handleReady);window.addEventListener("message",this.handleMessage,!1);this.on("received",this.handleReady)}t.boundHandlers=["handleTouchStart","handleTouchMove","handleTouchEnd","handleControlButtonClick","handleResize","handleTap","repositionImages","init","tick"];t.prototype.template='<div class="touch-gallery"><ul class="items"></ul><div class="top-bar"><a class="logo" href="#">Logo</a><div class="controls"><a class="prev">&laquo;</a><a class="next">&raquo;</a></div></div><div class="bottom-bar"><p>This is the description text</p><a href="#" class="permalink">Permalink</a></div></div>';t.prototype.preloadImages=function(t){function r(){--n||t()}var n=0;this.items=this.items.filter(function(t){switch(t.type){case"image":t.img=new Image;t.img.onload=r;t.img.src=t.src;n++;return!0;case"youtube":t.img=new Image;t.img.onload=r;t.img.src="http://img.youtube.com/vi/"+t.id+"/hqdefault.jpg";n++;return!0;case"vimeo":e.getJSON("http://vimeo.com/api/v2/video/"+t.id+".json?callback=?",function(e){t.img=new Image;t.img.onload=r;t.img.src=e[0].thumbnail_large});n++;return!0;case"video":t.img=new Image;t.img.onload=r;t.img.src=t.poster;n++;return!0}return!1})};t.prototype.init=function(){this.container.append(this.template);this.list=this.container.find(".items");this.items.forEach(function(t){var n=e("<li></li>");t.type=="image"&&n.append(this.createImage(t));t.type=="youtube"&&n.append(this.createYouTubeVideo(t)).addClass("video");t.type=="vimeo"&&n.append(this.createVimeoVideo(t)).addClass("video");t.type=="video"&&n.append(this.createVideoPlayer(t)).addClass("video");t.listItem=n;this.list.append(n)},this);this.list.get(0).addEventListener("touchstart",this.handleTouchStart);this.list.get(0).addEventListener("touchmove",this.handleTouchMove);this.list.get(0).addEventListener("touchend",this.handleTouchEnd);this.list.get(0).addEventListener("touchcancel",this.handleTouchEnd);var t=this.container.find(".top-bar .controls");t.on("click","a",this.handleControlButtonClick);this.repositionImages();this.moveTo(0,!0);this.readyHandler()};t.prototype.createImage=function(t){return e('<img src="'+t.src+'" alt=""/>')};t.prototype.createYouTubeVideo=function(t){var n="youtube-"+this.videoCounter++,r=this._createFragment(this.youtubeVideoTemplate({id:n,src:t.img.src}));t.poster=e(r.querySelector(".poster"));t.closeButton=e(r.querySelector(".close-button"));t.playerContainer=e(r.querySelector("#"+n));return r};t.prototype.youtubeVideoTemplate=tmpl('<div class="poster"><div class="top"><img src="<%= src %>"/></div><div class="bottom"><img src="<%= src %>"/></div><div class="play-icon"></div></div><div class="player-container"><div id="<%= id %>"></div></div><div class="left"></div><div class="right"><div class="close-button">X</div></div>');t.prototype.activateYouTubePlayer=function(e){this.hideBars();this.disableScrolling();e.poster.addClass("slide-out");e.player=new YT.Player(e.playerContainer.get(0),{width:this.list.width()-100,height:this.list.height(),videoId:e.id,events:{onReady:function(){console.log(arguments)},onStateChange:function(){console.log(arguments)},onError:function(){console.log(arguments)}}});var t=this;e.closeButton.on("tap",function(n){n.preventDefault();n.stopPropagation();t.destroyYouTubePlayer(e)})};t.prototype.destroyYouTubePlayer=function(e){e.player.destroy();e.player=null;e.playerContainer.children().remove();e.poster.removeClass("slide-out");this.showBars();this.enableScrolling()};t.prototype.createVimeoVideo=function(t){var n="vimeo-"+this.videoCounter++,r=this._createFragment(this.vimeoVideoTemplate({id:n,src:t.img.src}));t.poster=e(r.querySelector(".poster"));t.closeButton=e(r.querySelector(".close-button"));t.playerContainer=e(r.querySelector("#"+n));return r};t.prototype.vimeoVideoTemplate=tmpl('<div class="poster"><div class="top"><img src="<%= src %>"/></div><div class="bottom"><img src="<%= src %>"/></div><div class="play-icon"></div></div><div class="player-container"><div id="<%= id %>"></div></div><div class="left"></div><div class="right"><div class="close-button">X</div></div>');t.prototype.activateVimeoPlayer=function(t){this.hideBars();this.disableScrolling();t.poster.addClass("slide-out");var r=e("<iframe></iframe>").attr({width:this.list.width()-100,height:this.list.height(),src:"http://player.vimeo.com/video/"+t.id+"?api=1&player_id="+t.playerContainer.attr("id"),frameborder:"0",webkitAllowFullScreen:"yes",mozallowfullscreen:"yes",allowFullScreen:"yes"}).appendTo(t.playerContainer);t.player=new n(r[0]);t.player.on("received",function(e){console.warn(e)});var i=this;t.closeButton.on("tap",function(e){e.preventDefault();e.stopPropagation();i.destroyVimeoPlayer(t)})};t.prototype.destroyVimeoPlayer=function(e){e.player=null;e.listItem.find("iframe").remove();e.poster.removeClass("slide-out");e.player=null;this.showBars();this.enableScrolling()};t.prototype.createVideoPlayer=function(t){var n="video-"+this.videoCounter++,r=this._createFragment(this.videoPlayerTemplate({id:n,src:t.img.src,video:t.src}));t.poster=e(r.querySelector(".poster"));t.closeButton=e(r.querySelector(".close-button"));t.playerContainer=e(r.querySelector("#"+n));var i=this;t.closeButton.on("tap",function(e){t.poster.removeClass("slide-out");t.playerContainer.find("video")[0].pause();t.playerContainer.find("video").remove();i.enableScrolling();i.showBars()});return r};t.prototype.videoPlayerTemplate=tmpl('<div class="poster"><div class="top"><img src="<%= src %>"/></div><div class="bottom"><img src="<%= src %>"/></div><div class="play-icon"></div></div><div class="player-container"><div id="<%= id %>" class="video-player"></div></div><div class="left"></div><div class="right"><div class="close-button">X</div></div>');t.prototype.activateVideoPlayer=function(t){var n=e('<video controls preload poster="'+t.poster+'" src="'+t.src+'"></video>');n.appendTo(t.playerContainer);n.css({width:"100%",height:"100%"});n[0].load();n[0].play()};t.prototype._createFragment=function(t){var n=document.createDocumentFragment();e(t).each(function(){n.appendChild(this)});return n};t.prototype.repositionImages=function(){var t=this,n=this.list.width(),r=this.list.height(),i=n/r;this.list.children().each(function(t){var s=e(this);s.css("margin-left",t*100+"%");var o;if(s.is(".video")){var u=s.find(".top img"),a=s.find(".bottom img"),f=u[0].naturalWidth/u[0].naturalHeight;u.add(a).css({width:"100%",height:"auto",marginLeft:0});u.css({bottom:-n/f/2+"px"});a.last().css({top:-n/f/2+"px"})}else{var l=s.find("img");f=l[0].naturalWidth/l[0].naturalHeight;f>i?l.css({marginLeft:0,marginTop:(r-n/f)/2+"px",width:"100%",height:"auto"}):l.css({marginLeft:(n-r*f)/2+"px",marginTop:0,width:"auto",height:"100%"})}});this.moveTo(this.currentItem,!0);setTimeout(function(){t.list.css("opacity",1)},0)};t.prototype.snap=function(){var e=this.list.width(),t=e*Math.floor(this.position/e),n=e*Math.ceil(this.position/e);this.position-t<n-this.position?this.targetPosition=t:this.targetPosition=n;this.targetPosition=clamp(this.targetPosition,0,e*(this.items.length-1));this.currentItem=Math.floor(this.targetPosition/e);this.tick()};t.prototype.moveTo=function(e,t){this.currentItem=clamp(e,0,this.items.length-1);if(t){this.targetPosition=this.position=this.getPositionForIndex(this.currentItem);this.draw()}else{this.targetPosition=this.getPositionForIndex(this.currentItem);this.tick()}this.updateMetadata()};t.prototype.goToNext=function(){this.currentItem<this.items.length-1&&this.moveTo(this.currentItem+1)};t.prototype.goToPrevious=function(){this.currentItem>0&&this.moveTo(this.currentItem-1)};t.prototype.getPositionForIndex=function(e){return e*this.list.width()};t.prototype.updateMetadata=function(){var t=this.items[this.currentItem];e(".bottom-bar p",this.container).text(t.description||"");e(".bottom-bar .permalink",this.container).attr("href",t.link||"#")};t.prototype.tick=function(){(Math.abs(this.position-this.targetPosition)>1||this.interacting)&&requestAnimationFrame(this.tick);this.lastTickTime||(this.lastTickTime=+(new Date));var e=new Date-this.lastTickTime;this.interacting||this.update(e);this.draw();this.lastTickTime=+(new Date)};t.prototype.update=function(e){this.position+=(this.targetPosition-this.position)*this.easeFactor;Math.abs(this.position-this.targetPosition)<=1&&(this.position=this.targetPosition)};t.prototype.draw=function(){this.list.get(0).style.webkitTransform="translate("+ -this.position+"px, 0)"};t.prototype.handleTouchStart=function(e){if(!this._scrolling)return;var t=this.interacting?this._findTouch(e.changedTouches):e.changedTouches[0];if(t){e.preventDefault();if(!this.interacting){this.touchId=t.identifier;this.touchCoords={x:t.pageX,y:t.pageY};this.touchStartTime=new Date;this.initialPosition=this.position;this.tapCandidate=!0}this.interacting=!0;this.tick()}};t.prototype.handleTouchMove=function(e){if(!this._scrolling)return;var t=this._findTouch(e.changedTouches);if(t){e.preventDefault();var n=this.list.width()*(this.items.length-1);this.position=this.initialPosition+this.touchCoords.x-t.pageX;this.position<0&&(this.position/=6);this.position>n&&(this.position=n+this.position%n/6);if(this.tapCandidate){var r=Math.pow(this.touchCoords.x-t.pageX,2)+Math.pow(this.touchCoords.y-t.pageY,2);this.tapCandidate=r<900&&new Date-this.touchStartTime<400}this.targetPosition=this.position}};t.prototype.handleTouchEnd=function(e){if(!this._scrolling)return;e.preventDefault();this.touchId=null;this.touchCoords=null;this.interacting=!1;var t=this.targetPosition-this.initialPosition;if(Math.abs(t)/Math.min(this.list.width(),this.list.height())>this.swipeLength)t>0?this.goToNext():this.goToPrevious();else{this.snap();if(this.tapCandidate){this.handleTap();this.tapCandidate=!1}}};t.prototype.handleControlButtonClick=function(t){t.preventDefault();e(t.target).hasClass("prev")&&this.goToPrevious();e(t.target).hasClass("next")&&this.goToNext()};t.prototype.handleTap=function(){var e=this.items[this.currentItem];if(e.type=="youtube")e.player||this.activateYouTubePlayer(e);else if(e.type=="vimeo")e.player||this.activateVimeoPlayer(e);else if(e.type=="video"){this.hideBars();this.disableScrolling();e.poster.addClass("slide-out");this.activateVideoPlayer(e)}else if(e.type=="image"){this.stopAutoplay();this.toggleBars()}};t.prototype._findTouch=function(e){for(var t=0;t<e.length;t++)if(e[t].identifier==this.touchId)return e[t];return null};t.prototype.handleResize=function(){this.list.css("opacity",0);setTimeout(this.repositionImages,100)};t.prototype.hideBars=function(){this.container.find(".top-bar,.bottom-bar").addClass("fade-out")};t.prototype.showBars=function(){this.container.find(".top-bar,.bottom-bar").removeClass("fade-out")};t.prototype.toggleBars=function(){this.container.find(".top-bar,.bottom-bar").toggleClass("fade-out")};t.prototype.enableScrolling=function(){this._scrolling=!0};t.prototype.disableScrolling=function(){this._scrolling=!1};n.prototype.send=function(e){this.iframe.contentWindow.postMessage(JSON.stringify(e),this.iframe.src.split("?")[0])};n.prototype.handleMessage=function(e){this.emit("received",JSON.parse(e.data))};n.prototype.handleReady=function(e){if(!this.ready&&e.event=="ready"){this.ready=!0;this.send({method:"addEventListener",value:"play"});this.send({method:"addEventListener",value:"pause"});this.send({method:"addEventListener",value:"playProgress"})}this.off("received",this.handleReady)};this.TouchGallery=t})(Zepto);